<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù†Ø¸Ø§Ù… Ø±ÙØ¹ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¥Ø®Ù„Ø§Ø¡</title>
  <style>
    body {
      font-family: 'Cairo', Tahoma, sans-serif;
      background: #f2fdf7;
      margin: 0;
      color: #333;
    }

    /* ======= Ø§Ù„Ù‡ÙŠØ¯Ø± ======= */
    header {
      background: #006c35;
      color: white;
      padding: 10px 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    header img {
      height: 45px;
    }
    header h2 {
      font-size: 16px;
      line-height: 1.4;
      margin: 0;
      text-align: center;
    }

    /* ======= Ø§Ù„Ø­Ø§ÙˆÙŠØ© ======= */
    .container {
      max-width: 95%;
      margin: 15px auto;
      background: white;
      padding: 20px;
      border-radius: 14px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }

    h3 { margin-top: 0; }

    label {
      display: block;
      margin-top: 12px;
      font-weight: bold;
      font-size: 14px;
    }

    select, input, textarea, button {
      width: 100%;
      padding: 12px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 10px;
      font-size: 14px;
      box-sizing: border-box;
    }

    textarea { resize: vertical; min-height: 80px; }

    button {
      background: #006c35;
      color: white;
      font-size: 15px;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s;
      border: none;
    }
    button:hover, button:active {
      background: #004d27;
      transform: scale(0.98);
    }

    .back-btn {
      margin-top: 15px;
      background: #555;
    }
    .back-btn:hover { background:#333; }

    /* ======= Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª ======= */
    #status { margin-top: 15px; font-weight: bold; font-size: 14px; }
    .error { color: red; }
    .success { color: green; }
    .loading { color:#ff9800; }

    /* ======= Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø®ØµØµØ© ======= */
    .dropdown { position: relative; width: 100%; }
    .dropdown-toggle {
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 10px;
      background: #fff;
      cursor: pointer;
    }
    .dropdown-menu {
      display: none;
      position: absolute;
      top: 100%; right: 0; left: 0;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 10px;
      max-height: 250px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .dropdown-menu input {
      width: 90%;
      margin: 10px auto;
      display: block;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    .dropdown-item {
      padding: 12px;
      cursor: pointer;
      font-size: 14px;
    }
    .dropdown-item:hover {
      background: #f1f1f1;
    }

    /* ======= Ø¯Ø¹Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ======= */
    @media (max-width: 600px) {
      header h2 {
        font-size: 14px;
      }
      button {
        font-size: 14px;
        padding: 10px;
      }
    }
  </style>
</head>
<body>
  <header>
    <img src="assets/logo.png" alt="Ø´Ø¹Ø§Ø± ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…">
    <h2>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„ØªØ¹Ù„ÙŠÙ… Ø¨Ù…Ù†Ø·Ù‚Ø© Ø¹Ø³ÙŠØ± - Ø§Ù„Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ© - Ù†Ø¸Ø§Ù… Ø±ÙØ¹ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¥Ø®Ù„Ø§Ø¡</h2>
  </header>

  <div class="container">
    <h3>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ğŸ‘‹</h3>

    <label>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</label>
    <select id="cityFilter"></select>

    <label>Ø§Ù„Ù†ÙˆØ¹:</label>
    <select id="typeFilter"></select>

    <label>Ø§Ù„Ù…Ø¯Ø±Ø³Ø©:</label>
    <div class="dropdown">
      <div class="dropdown-toggle" id="schoolDropdown">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</div>
      <div class="dropdown-menu" id="dropdownMenu">
        <input type="text" id="schoolSearch" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¯Ø±Ø³Ø©">
        <div id="schoolList"></div>
      </div>
    </div>

    <div id="schoolData" style="display:none;">
      <h3>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</h3>
      <p><b>Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©:</b> <span id="schoolName"></span></p>
      <p><b>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</b> <span id="schoolCity"></span></p>

      <label>Ø§Ù„Ù†ÙˆØ¹:</label>
      <input type="text" id="typeInput" readonly>

      <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨:</label>
      <input type="number" id="students">

      <label>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†Ø³ÙˆØ¨ÙŠÙ†:</label>
      <input type="number" id="staff">

      <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø³Ù‚:</label>
      <input type="text" id="coordinator">

      <label>Ø§Ù„ÙƒØ§Ø¯Ø±:</label>
      <select id="kader">
        <option value="ØªØ¹Ù„ÙŠÙ…ÙŠ">ØªØ¹Ù„ÙŠÙ…ÙŠ</option>
        <option value="Ø¥Ø¯Ø§Ø±ÙŠ">Ø¥Ø¯Ø§Ø±ÙŠ</option>
      </select>

      <label>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ†ÙÙŠØ°:</label>
      <input type="date" id="executionDate">

      <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</label>
      <textarea id="notes"></textarea>

      <label>Ø±ÙØ¹ ØªÙ‚Ø±ÙŠØ± PDF:</label>
      <input type="file" id="fileInput" accept="application/pdf">

      <label><input type="checkbox" id="confirmData"> Ø£ØªØ¹Ù‡Ø¯ Ø¨ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø®Ù„Ø©</label>

      <button onclick="upload()">Ø­ÙØ¸ ÙˆØ±ÙØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
    </div>

    <p id="status"></p>
    <button class="back-btn" onclick="goHome()">â¬…ï¸ Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ø¯ÙŠØ¯</button>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxUTKycoHzYDdyT8I-N07RWpl6C3R7jPuWsbVJkL5FAV8yfLzk_8yadUfxUpCZhX1vz/exec";
    let schools = [];
    let filteredSchools = [];

    async function loadSchools() {
      document.getElementById("status").innerHTML = "<span class='loading'>â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</span>";
      const res = await fetch(API_URL + "?action=getSchools");
      schools = await res.json();
      loadFilters();
      document.getElementById("status").innerHTML = "";
    }

    function loadFilters() {
      const cities = [...new Set(schools.map(s => s[0]))];
      const types = [...new Set(schools.map(s => s[2]))];
      document.getElementById("cityFilter").innerHTML = "<option disabled selected>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</option>" + cities.map(c => `<option>${c}</option>`).join("");
      document.getElementById("typeFilter").innerHTML = "<option disabled selected>Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹</option>" + types.map(t => `<option>${t}</option>`).join("");
      document.getElementById("cityFilter").addEventListener("change", updateSchools);
      document.getElementById("typeFilter").addEventListener("change", updateSchools);
    }

    function updateSchools() {
      const city = document.getElementById("cityFilter").value;
      const type = document.getElementById("typeFilter").value;
      filteredSchools = schools.filter(s => s[0] === city && s[2] === type);
      renderSchoolList(filteredSchools);
    }

    function renderSchoolList(list) {
      const container = document.getElementById("schoolList");
      container.innerHTML = "";
      list.forEach(s => {
        const div = document.createElement("div");
        div.className = "dropdown-item";
        div.textContent = s[1];
        div.onclick = () => selectSchool(s);
        container.appendChild(div);
      });
    }

    function selectSchool(selected) {
      document.getElementById("schoolDropdown").textContent = selected[1];
      document.getElementById("dropdownMenu").style.display = "none";

      if (selected[8] === "ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°") {
        document.getElementById("status").innerHTML = "<span class='success'>âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù…Ø³Ø¨Ù‚Ø§Ù‹ØŒ Ø´ÙƒØ±Ø§Ù‹ Ù„ÙƒÙ….</span>";
        document.getElementById("schoolData").style.display = "none";
      } else {
        document.getElementById("status").innerHTML = "";
        document.getElementById("schoolData").style.display = "block";
        document.getElementById("schoolName").textContent = selected[1];
        document.getElementById("schoolCity").textContent = selected[0];
        document.getElementById("typeInput").value = selected[2];
        document.getElementById("students").value = selected[3];
        document.getElementById("staff").value = selected[4];
        document.getElementById("coordinator").value = selected[5];
        document.getElementById("kader").value = selected[6] || "ØªØ¹Ù„ÙŠÙ…ÙŠ";
        document.getElementById("executionDate").value = selected[7] || "";
        document.getElementById("notes").value = selected[9] || "";
      }
    }

    document.getElementById("schoolDropdown").addEventListener("click", () => {
      const menu = document.getElementById("dropdownMenu");
      menu.style.display = menu.style.display === "block" ? "none" : "block";
      document.getElementById("schoolSearch").value = "";
      renderSchoolList(filteredSchools);
    });

    document.getElementById("schoolSearch").addEventListener("input", () => {
      const query = document.getElementById("schoolSearch").value.toLowerCase();
      const filtered = filteredSchools.filter(s => s[1].toLowerCase().includes(query));
      renderSchoolList(filtered);
    });

    async function upload() {
      if (!document.getElementById("confirmData").checked) {
        alert("ÙŠØ¬Ø¨ ØªØ£ÙƒÙŠØ¯ ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸");
        return;
      }

      const schoolName = document.getElementById("schoolDropdown").textContent;
      if (schoolName === "Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©") { alert("Ø§Ø®ØªØ± Ù…Ø¯Ø±Ø³Ø©"); return; }

      const students = document.getElementById("students").value;
      const staff = document.getElementById("staff").value;
      const coordinator = document.getElementById("coordinator").value;
      const kader = document.getElementById("kader").value;
      const executionDate = document.getElementById("executionDate").value;
      const notes = document.getElementById("notes").value;
      const file = document.getElementById("fileInput").files[0];

      if (!file) { alert("Ø§Ø®ØªØ± Ù…Ù„Ù PDF"); return; }

      document.getElementById("status").innerHTML = "<span class='loading'>â³ Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±...</span>";

      const reader = new FileReader();
      reader.onload = async function(e) {
        const base64Data = e.target.result.split(",")[1];
        const payload = { 
          action: "uploadFile", 
          schoolName, students, staff, coordinator, kader, executionDate, notes, base64Data 
        };
        const res = await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) });
        const result = await res.json();

        if (result.status === "already_done") {
          document.getElementById("status").innerHTML = "<span class='success'>âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù…Ø³Ø¨Ù‚Ø§Ù‹ØŒ Ø´ÙƒØ±Ø§Ù‹ Ù„ÙƒÙ….</span>";
        } else if (result.status === "success") {
          document.getElementById("status").innerHTML = "<span class='success'>âœ… Ø´ÙƒØ±Ù‹Ø§ Ù„Ùƒ! ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙˆØ±ÙØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­. <a href='" + result.url + "' target='_blank'>Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</a></span>";
          document.getElementById("schoolData").style.display = "none";
        } else {
          document.getElementById("status").innerHTML = "<span class='error'>âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸</span>";
        }
      };
      reader.readAsDataURL(file);
    }

    function goHome() { location.reload(); }

    loadSchools();
  </script>
</body>
</html>
