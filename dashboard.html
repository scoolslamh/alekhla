<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ù„ÙˆØ­Ø© Ù…ØªØ§Ø¨Ø¹Ø© ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¥Ø®Ù„Ø§Ø¡</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Cairo', Tahoma, sans-serif; background:#f4f6f9; margin:0; }
    header { background:#006c35; color:white; padding:15px; text-align:center; display:flex; align-items:center; justify-content:center; gap:15px; }
    header img { height:50px; }
    .container { max-width:1200px; margin:20px auto; padding:20px; }

    /* Ø§Ù„ÙƒØ±ÙˆØª */
    .cards { display:grid; grid-template-columns: repeat(auto-fit,minmax(250px,1fr)); gap:20px; }
    .card {
      background:white; padding:20px; border-radius:12px;
      box-shadow:0 4px 8px rgba(0,0,0,0.1); text-align:center;
    }
    .card h2 { margin:0; font-size:2em; color:#006c35; }
    .card p { margin:5px 0 0; color:#555; }

    /* Ø§Ù„ÙÙ„Ø§ØªØ± */
    .filters { margin:20px 0; display:flex; justify-content:flex-start; gap:10px; align-items:center; }
    select, button {
      padding:10px; border-radius:6px; border:1px solid #ccc; cursor:pointer;
    }
    button { background:#006c35; color:white; }
    button:hover { background:#004d27; }

    /* Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ */
    table {
      width:100%; border-collapse:collapse; background:white;
      box-shadow:0 2px 6px rgba(0,0,0,0.1);
    }
    th, td { border:1px solid #ddd; padding:10px; text-align:center; }
    th { background:#006c35; color:white; }
    tr:nth-child(even) { background:#f9f9f9; }

    /* NEW: Ø¬Ø¹Ù„ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙÙŠ ØµÙ†Ø§Ø¯ÙŠÙ‚ Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªÙ…Ø±ÙŠØ± */
    .table-container {
      max-height: 350px; /* Ø§Ø±ØªÙØ§Ø¹ Ø«Ø§Ø¨Øª */
      overflow-y: auto;  /* Ø´Ø±ÙŠØ· ØªÙ…Ø±ÙŠØ± Ø¹Ù…ÙˆØ¯ÙŠ */
      margin-top: 10px;
      border-radius: 8px;
    }

    /* Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© */
    .charts { 
      display:grid; 
      grid-template-columns: repeat(auto-fit,minmax(350px,1fr)); 
      gap:20px; 
      margin-top:30px; 
      justify-content:center;
    }
    .chart-box {
      background:white; 
      padding:15px; 
      border-radius:12px; 
      box-shadow:0 2px 6px rgba(0,0,0,0.1); 
      display:flex; 
      justify-content:center; 
      align-items:center;
    }
    canvas { 
      max-width:400px; 
      max-height:300px; 
      width:100%; 
      height:auto; 
    }
  </style>
</head>
<body>
  <header>
    <img src="assets/logo.png" alt="Ø´Ø¹Ø§Ø± ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…">
    <h2>Ù„ÙˆØ­Ø© Ù…ØªØ§Ø¨Ø¹Ø© ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¥Ø®Ù„Ø§Ø¡</h2>
  </header>

  <div class="container">
    <!-- Ø§Ù„ÙƒØ±ÙˆØª -->
    <div class="cards">
      <div class="card">
        <h2 id="totalSchools">0</h2>
        <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³</p>
      </div>
      <div class="card">
        <h2 id="executedSchools">0</h2>
        <p>Ù…Ø¯Ø§Ø±Ø³ Ù…Ù†ÙØ°Ø©</p>
      </div>
      <div class="card">
        <h2 id="notExecutedSchools">0</h2>
        <p>Ù…Ø¯Ø§Ø±Ø³ ØºÙŠØ± Ù…Ù†ÙØ°Ø©</p>
      </div>
      <div class="card">
        <h2 id="completionRate">0%</h2>
        <p>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</p>
      </div>
    </div>

    <!-- Ø§Ù„ÙÙ„Ø§ØªØ± -->
    <div class="filters">
      <label>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</label>
      <select id="cityFilter">
        <option value="all">Ø§Ù„ÙƒÙ„</option>
      </select>
    </div>

    <!-- Ø§Ù„Ø£Ø²Ø±Ø§Ø± -->
    <div style="margin:15px 0;">
      <button onclick="exportExcel('executed')">ğŸ“¥ ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„Ù…Ù†ÙØ°Ø©</button>
      <button onclick="exportExcel('notExecuted')">ğŸ“¥ ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ ØºÙŠØ± Ø§Ù„Ù…Ù†ÙØ°Ø©</button>
    </div>

    <!-- Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© -->
    <div class="charts">
      <div class="chart-box"><canvas id="pieChart"></canvas></div>
      <div class="chart-box"><canvas id="barChart"></canvas></div>
    </div>

    <!-- Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ -->
    <h3>Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„Ù…Ù†ÙØ°Ø©</h3>
    <div class="table-container">
      <table id="executedTable">
        <thead><tr><th>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</th><th>Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</th><th>Ø§Ù„Ù†ÙˆØ¹</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <h3>Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ ØºÙŠØ± Ø§Ù„Ù…Ù†ÙØ°Ø©</h3>
    <div class="table-container">
      <table id="notExecutedTable">
        <thead><tr><th>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</th><th>Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</th><th>Ø§Ù„Ù†ÙˆØ¹</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzrQw6bOyh7Wm8Av6YCwwooDd27ghda5YEenkjfl94jg3F6VHoldxM4JbCVCcU7yNaK/exec";
    let allData = [];
    let pieChart, barChart;

    async function loadStats() {
      try {
        const res = await fetch(API_URL + "?action=getSchools");
        allData = await res.json();
        updateDashboard();
        loadCities();
      } catch (err) {
        console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", err);
        alert("ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù….");
      }
    }

    function loadCities() {
      const cities = [...new Set(allData.map(s => s[0]))];
      const select = document.getElementById("cityFilter");
      select.innerHTML = `<option value="all">Ø§Ù„ÙƒÙ„</option>` + cities.map(c => `<option>${c}</option>`).join("");
      select.addEventListener("change", updateDashboard);
    }

    function updateDashboard() {
      const city = document.getElementById("cityFilter").value;
      const filtered = city === "all" ? allData : allData.filter(s => s[0] === city);

      const total = filtered.length;
      const executed = filtered.filter(s => s[8] === "ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°");
      const notExecuted = filtered.filter(s => s[8] !== "ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°");

      document.getElementById("totalSchools").textContent = total;
      document.getElementById("executedSchools").textContent = executed.length;
      document.getElementById("notExecutedSchools").textContent = notExecuted.length;
      document.getElementById("completionRate").textContent = total > 0 ? Math.round((executed.length/total)*100) + "%" : "0%";

      renderTable("executedTable", executed);
      renderTable("notExecutedTable", notExecuted);
      renderCharts(executed.length, notExecuted.length, city);
    }

    function renderTable(id, rows) {
      const tbody = document.getElementById(id).querySelector("tbody");
      tbody.innerHTML = "";
      rows.forEach(r => {
        tbody.innerHTML += `<tr><td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td></tr>`;
      });
    }

    function renderCharts(executedCount, notExecutedCount, city) {
      if (pieChart) pieChart.destroy();
      pieChart = new Chart(document.getElementById("pieChart"), {
        type: "pie",
        data: {
          labels: ["Ù…Ù†ÙØ°Ø©", "ØºÙŠØ± Ù…Ù†ÙØ°Ø©"],
          datasets: [{
            data: [executedCount, notExecutedCount],
            backgroundColor: ["#4CAF50", "#F44336"]
          }]
        },
        options: { responsive: true, plugins: { title: { display: true, text: "Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙ†ÙÙŠØ°" } } }
      });

      if (barChart) barChart.destroy();
      const cityData = {};
      (city === "all" ? allData : allData.filter(s => s[0] === city)).forEach(s => {
        if (!cityData[s[0]]) cityData[s[0]] = { executed: 0, notExecuted: 0 };
        if (s[8] === "ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°") cityData[s[0]].executed++;
        else cityData[s[0]].notExecuted++;
      });

      barChart = new Chart(document.getElementById("barChart"), {
        type: "bar",
        data: {
          labels: Object.keys(cityData),
          datasets: [
            { label: "Ù…Ù†ÙØ°Ø©", data: Object.values(cityData).map(d => d.executed), backgroundColor: "#4CAF50" },
            { label: "ØºÙŠØ± Ù…Ù†ÙØ°Ø©", data: Object.values(cityData).map(d => d.notExecuted), backgroundColor: "#F44336" }
          ]
        },
        options: {
          responsive: true,
          plugins: { title: { display: true, text: "Ø§Ù„ØªÙ†ÙÙŠØ° Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©" } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    async function exportExcel(type) {
      try {
        const res = await fetch(API_URL + "?action=export&type=" + type);
        const data = await res.json();
        if (data.status === "success" && data.url) {
          window.open(data.url, "_blank");
        } else {
          alert("ÙØ´Ù„ Ø§Ù„ØªØµØ¯ÙŠØ±ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
        }
      } catch (err) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±", err);
        alert("ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù… Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØµØ¯ÙŠØ±.");
      }
    }

    loadStats();
  </script>
</body>
</html>
