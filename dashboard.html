<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>لوحة متابعة تقارير الإخلاء</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Cairo', Tahoma, sans-serif; background:#f4f6f9; margin:0; }
    header { background:#006c35; color:white; padding:15px; text-align:center; display:flex; align-items:center; justify-content:center; gap:15px; }
    header img { height:50px; }
    .container { max-width:1200px; margin:20px auto; padding:20px; }

    /* الكروت */
    .cards { display:grid; grid-template-columns: repeat(auto-fit,minmax(250px,1fr)); gap:20px; }
    .card {
      background:white; padding:20px; border-radius:12px;
      box-shadow:0 4px 8px rgba(0,0,0,0.1); text-align:center;
    }
    .card h2 { margin:0; font-size:2em; color:#006c35; }
    .card p { margin:5px 0 0; color:#555; }

    /* الفلاتر */
    .filters { margin:20px 0; display:flex; justify-content:flex-start; gap:10px; align-items:center; }
    select, button {
      padding:10px; border-radius:6px; border:1px solid #ccc; cursor:pointer;
    }
    button { background:#006c35; color:white; }
    button:hover { background:#004d27; }

    /* الجداول */
    table {
      width:100%; border-collapse:collapse; background:white;
      box-shadow:0 2px 6px rgba(0,0,0,0.1);
    }
    th, td { border:1px solid #ddd; padding:10px; text-align:center; }
    th { background:#006c35; color:white; }
    tr:nth-child(even) { background:#f9f9f9; }

    /* NEW: جعل الجداول في صناديق قابلة للتمرير */
    .table-container {
      max-height: 350px; /* ارتفاع ثابت */
      overflow-y: auto;  /* شريط تمرير عمودي */
      margin-top: 10px;
      border-radius: 8px;
    }

    /* الرسوم البيانية */
    .charts { 
      display:grid; 
      grid-template-columns: repeat(auto-fit,minmax(350px,1fr)); 
      gap:20px; 
      margin-top:30px; 
      justify-content:center;
    }
    .chart-box {
      background:white; 
      padding:15px; 
      border-radius:12px; 
      box-shadow:0 2px 6px rgba(0,0,0,0.1); 
      display:flex; 
      justify-content:center; 
      align-items:center;
    }
    canvas { 
      max-width:400px; 
      max-height:300px; 
      width:100%; 
      height:auto; 
    }
  </style>
</head>
<body>
  <header>
    <img src="assets/logo.png" alt="شعار وزارة التعليم">
    <h2>لوحة متابعة تقارير الإخلاء</h2>
  </header>

  <div class="container">
    <!-- الكروت -->
    <div class="cards">
      <div class="card">
        <h2 id="totalSchools">0</h2>
        <p>إجمالي المدارس</p>
      </div>
      <div class="card">
        <h2 id="executedSchools">0</h2>
        <p>مدارس منفذة</p>
      </div>
      <div class="card">
        <h2 id="notExecutedSchools">0</h2>
        <p>مدارس غير منفذة</p>
      </div>
      <div class="card">
        <h2 id="completionRate">0%</h2>
        <p>نسبة الإنجاز</p>
      </div>
    </div>

    <!-- الفلاتر -->
    <div class="filters">
      <label>اختر المدينة:</label>
      <select id="cityFilter">
        <option value="all">الكل</option>
      </select>
    </div>

    <!-- الأزرار -->
    <div style="margin:15px 0;">
      <button onclick="exportExcel('executed')">📥 تصدير المدارس المنفذة</button>
      <button onclick="exportExcel('notExecuted')">📥 تصدير المدارس غير المنفذة</button>
    </div>

    <!-- الرسوم البيانية -->
    <div class="charts">
      <div class="chart-box"><canvas id="pieChart"></canvas></div>
      <div class="chart-box"><canvas id="barChart"></canvas></div>
    </div>

    <!-- الجداول -->
    <h3>المدارس المنفذة</h3>
    <div class="table-container">
      <table id="executedTable">
        <thead><tr><th>المدينة</th><th>اسم المدرسة</th><th>النوع</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <h3>المدارس غير المنفذة</h3>
    <div class="table-container">
      <table id="notExecutedTable">
        <thead><tr><th>المدينة</th><th>اسم المدرسة</th><th>النوع</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzrQw6bOyh7Wm8Av6YCwwooDd27ghda5YEenkjfl94jg3F6VHoldxM4JbCVCcU7yNaK/exec";
    let allData = [];
    let pieChart, barChart;

    async function loadStats() {
      try {
        const res = await fetch(API_URL + "?action=getSchools");
        allData = await res.json();
        updateDashboard();
        loadCities();
      } catch (err) {
        console.error("خطأ في تحميل البيانات", err);
        alert("تعذر تحميل البيانات من الخادم.");
      }
    }

    function loadCities() {
      const cities = [...new Set(allData.map(s => s[0]))];
      const select = document.getElementById("cityFilter");
      select.innerHTML = `<option value="all">الكل</option>` + cities.map(c => `<option>${c}</option>`).join("");
      select.addEventListener("change", updateDashboard);
    }

    function updateDashboard() {
      const city = document.getElementById("cityFilter").value;
      const filtered = city === "all" ? allData : allData.filter(s => s[0] === city);

      const total = filtered.length;
      const executed = filtered.filter(s => s[8] === "تم التنفيذ");
      const notExecuted = filtered.filter(s => s[8] !== "تم التنفيذ");

      document.getElementById("totalSchools").textContent = total;
      document.getElementById("executedSchools").textContent = executed.length;
      document.getElementById("notExecutedSchools").textContent = notExecuted.length;
      document.getElementById("completionRate").textContent = total > 0 ? Math.round((executed.length/total)*100) + "%" : "0%";

      renderTable("executedTable", executed);
      renderTable("notExecutedTable", notExecuted);
      renderCharts(executed.length, notExecuted.length, city);
    }

    function renderTable(id, rows) {
      const tbody = document.getElementById(id).querySelector("tbody");
      tbody.innerHTML = "";
      rows.forEach(r => {
        tbody.innerHTML += `<tr><td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td></tr>`;
      });
    }

    function renderCharts(executedCount, notExecutedCount, city) {
      if (pieChart) pieChart.destroy();
      pieChart = new Chart(document.getElementById("pieChart"), {
        type: "pie",
        data: {
          labels: ["منفذة", "غير منفذة"],
          datasets: [{
            data: [executedCount, notExecutedCount],
            backgroundColor: ["#4CAF50", "#F44336"]
          }]
        },
        options: { responsive: true, plugins: { title: { display: true, text: "نسبة التنفيذ" } } }
      });

      if (barChart) barChart.destroy();
      const cityData = {};
      (city === "all" ? allData : allData.filter(s => s[0] === city)).forEach(s => {
        if (!cityData[s[0]]) cityData[s[0]] = { executed: 0, notExecuted: 0 };
        if (s[8] === "تم التنفيذ") cityData[s[0]].executed++;
        else cityData[s[0]].notExecuted++;
      });

      barChart = new Chart(document.getElementById("barChart"), {
        type: "bar",
        data: {
          labels: Object.keys(cityData),
          datasets: [
            { label: "منفذة", data: Object.values(cityData).map(d => d.executed), backgroundColor: "#4CAF50" },
            { label: "غير منفذة", data: Object.values(cityData).map(d => d.notExecuted), backgroundColor: "#F44336" }
          ]
        },
        options: {
          responsive: true,
          plugins: { title: { display: true, text: "التنفيذ حسب المدينة" } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    async function exportExcel(type) {
      try {
        const res = await fetch(API_URL + "?action=export&type=" + type);
        const data = await res.json();
        if (data.status === "success" && data.url) {
          window.open(data.url, "_blank");
        } else {
          alert("فشل التصدير، حاول مرة أخرى.");
        }
      } catch (err) {
        console.error("خطأ في التصدير", err);
        alert("تعذر الاتصال بالخادم أثناء التصدير.");
      }
    }

    loadStats();
  </script>
</body>
</html>
